{% comment %}
  Hydrogen Performance System Initialization
  Only loads when enabled in theme settings
{% endcomment %}

<script>
  // Always set configuration (even if disabled)
  window.hydrogenConfig = {
    enableNavigation: {{ settings.enable_hydrogen_navigation | default: false | json }},
    enableServiceWorker: {{ settings.enable_service_worker | default: false | json }},
    enablePrefetching: {{ settings.enable_prefetching | default: false | json }},
    transitionSpeed: {{ settings.transition_speed | default: 'fast' | json }},
    showLoadingIndicator: {{ settings.show_loading_indicator | default: false | json }},
    
    // Loading Bar Settings
    loadingStyle: {{ settings.loading_bar_style | default: 'default' | json }},
    loadingHeight: {{ settings.loading_bar_height | default: 4 | json }},
    
    // Performance settings
    preloadThreshold: 65, // ms hover before preload
    cacheSize: 50, // max cached pages
    
    // Debug mode in theme editor
    debug: {{ request.design_mode | json }},
    
    // Theme editor detection
    isThemeEditor: {{ request.design_mode | json }}
  };

  // Initialize when navigation system is ready
  document.addEventListener('DOMContentLoaded', function() {
    // Log current status
    if (window.hydrogenConfig.isThemeEditor) {
      console.log('üé® Theme Editor mode - Hydrogen Navigation disabled');
    } else if (!window.hydrogenConfig.enableNavigation) {
      console.log('‚öôÔ∏è Hydrogen Navigation disabled in settings');
    } else if (window.hydrogenNav) {
      console.log('üöÄ Hydrogen Navigation enabled');
      
      // Configure transition speed
      const speeds = {
        fast: 150,
        normal: 300,
        slow: 500
      };
      
      const speed = speeds[window.hydrogenConfig.transitionSpeed] || 150;
      document.documentElement.style.setProperty('--hydrogen-transition-speed', speed + 'ms');
      
      // Configure loading indicator
      if (!window.hydrogenConfig.showLoadingIndicator) {
        document.documentElement.style.setProperty('--hydrogen-loading-display', 'none');
      }
    }
  });

  // Performance monitoring in debug mode
  {% if request.design_mode %}
  window.addEventListener('load', function() {
    setTimeout(function() {
      if (window.reportPerformance) {
        console.log('üéØ Theme Editor Performance Report:');
        window.reportPerformance();
      }
    }, 1000);
  });
  {% endif %}
</script>

<!-- CSS Custom Properties for Settings -->
{% if settings.enable_hydrogen_navigation %}
<style>
  :root {
    --hydrogen-transition-speed: {{ settings.transition_speed == 'fast' ? '150ms' : settings.transition_speed == 'slow' ? '500ms' : '300ms' }};
    --hydrogen-loading-display: {{ settings.show_loading_indicator ? 'block' : 'none' }};
    --hydrogen-loading-height: {{ settings.loading_bar_height | default: 4 }}px;
  }
  
  {% unless settings.show_loading_indicator %}
  #instant-loading {
    display: none !important;
  }
  {% endunless %}
  
  /* Loading Bar Height */
  #instant-loading {
    height: var(--hydrogen-loading-height);
  }
  
  /* Loading Bar Styles */
  {% if settings.loading_bar_style == 'gradient' %}
  .loading-bar {
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57) !important;
    background-size: 300% 100% !important;
    animation: gradient-shift 2s ease infinite, loading-shimmer 1.5s infinite !important;
  }
  {% elsif settings.loading_bar_style == 'neon' %}
  .loading-bar {
    background: linear-gradient(90deg, #00f5ff, #ff00ff, #00f5ff) !important;
    box-shadow: 0 0 10px rgba(0, 245, 255, 0.5) !important;
    background-size: 200% 100% !important;
  }
  {% elsif settings.loading_bar_style == 'minimal' %}
  .loading-bar {
    background: rgb(var(--color-foreground, 0, 0, 0)) !important;
    opacity: 0.6 !important;
  }
  .loading-bar::before {
    display: none !important;
  }
  {% endif %}
  
  {% if settings.hide_loading_cursor %}
  /* Hide loading cursor when requested */
  .page-loading {
    cursor: auto !important;
  }
  {% endif %}
  
  {% if settings.transition_speed == 'slow' %}
  #MainContent {
    transition: opacity 0.5s ease-out;
  }
  {% elsif settings.transition_speed == 'fast' %}
  #MainContent {
    transition: opacity 0.15s ease-out;
  }
  {% endif %}
</style>
{% endif %}

{% comment %}
  Preload critical resources for better performance
{% endcomment %}
<link rel="preload" href="{{ 'hydrogen-navigation.js' | asset_url }}" as="script">
<link rel="preload" href="{{ 'performance-optimizer.js' | asset_url }}" as="script">

{% comment %}
  Add performance hints to important links
{% endcomment %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add prefetch hints to navigation links
    const navLinks = document.querySelectorAll('nav a[href], .header__menu a[href]');
    navLinks.forEach(function(link) {
      if (link.hostname === location.hostname) {
        link.setAttribute('data-prefetch', 'true');
      }
    });
    
    // Add high priority to product images
    const productImages = document.querySelectorAll('.card-product img, .product__media img');
    productImages.forEach(function(img, index) {
      if (index < 4) { // First 4 images
        img.loading = 'eager';
        img.fetchPriority = 'high';
      }
    });
  });
</script>